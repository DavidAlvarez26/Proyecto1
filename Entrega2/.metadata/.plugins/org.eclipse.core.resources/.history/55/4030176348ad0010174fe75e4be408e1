package persistencia;

import java.io.BufferedReader;
import java.util.List;
import java.io.*;
import java.sql.Date;
import java.util.*;

import logica.*;
import Usuarios.Cliente;
import Tiquetes.TiqueteBasico;

import logica.Tiquete;

public class PersistenciaTiquetes implements IPersistenciaTiquetes {

    @Override
    public List<Tiquete> cargarTiquetes(String archivo, List<Usuario> usuarios, List<Evento> eventos) {
        List<Tiquete> tiquetes = new ArrayList<>();

        try (BufferedReader br = new BufferedReader(new FileReader(archivo))) {
            String linea;
            while ((linea = br.readLine()) != null) {
                String[] partes = linea.split(";");

                String id = partes[0];
                String nombreEvento = partes[1];
                Date fecha = Date.valueOf(partes[2]);
                String localidad = partes[3];
                String nombreCliente = partes[4];
                double precioBase = Double.parseDouble(partes[5]);
                double cargoServicio = Double.parseDouble(partes[6]);
                double cuota = Double.parseDouble(partes[7]);
                boolean activo = Boolean.parseBoolean(partes[8]);
                String estado = partes[9];

                Evento evento = eventos.stream()
                        .filter(e -> e.getNombre().equalsIgnoreCase(nombreEvento))
                        .findFirst().orElse(null);

                Cliente cliente = (Cliente) usuarios.stream()
                        .filter(u -> u.getNombre().equalsIgnoreCase(nombreCliente))
                        .findFirst().orElse(null);

                if (evento != null && cliente != null) {
                    Tiquete t = new TiqueteBasico(precioBase, cargoServicio, id.hashCode(), evento,
                            cliente, evento.getLocalidades().get(0), estado, activo, localidad);

                    tiquetes.add(t);
                    cliente.getTiquetes().add(t);
                }
            }
        } catch (IOException e) {
            System.err.println("Error cargando tiquetes: " + e.getMessage());
        }

        return tiquetes;
    }
    @Override
    public void guardarTiquetes(String archivo, List<Tiquete> tiquetes) {
        try (PrintWriter pw = new PrintWriter(new FileWriter(archivo))) {
            for (Tiquete t : tiquetes) {
                pw.println(
                    "TQ" + t.getIdTiquete() + ";" +
                    t.getEvento().getNombre() + ";" +
                    t.getFechaEvento() + ";" +
                    t.getLocalidad().getNombre() + ";" +
                    t.getComprador().getNombre() + ";" +
                    t.getLocalidad().getPrecioLocalidad() + ";" +
                    t.getCargoServicio() + ";" +
                    t.getCuotaAdicional() + ";" +
                    t.esTransferible() + ";" +
                    t.getEstado()
                );
            }
            System.out.println("Archivo de tiquetes guardado correctamente en: " + archivo);
        } catch (IOException e) {
            System.out.println("Error al guardar los tiquetes: " + e.getMessage());
        }
    }
}
